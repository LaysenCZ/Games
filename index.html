<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Živý svět hráčů – MVP</title>
<style>
  html,body{margin:0;padding:0;background:#0e0f11;color:#e7e7ea;font-family:Inter,system-ui,Arial}
  #game{display:block;width:100vw;height:70vh;background:#1a1c20}
  .hud{position:fixed;left:16px;right:16px;bottom:16px;display:grid;gap:8px}
  .bars{display:grid;grid-template-columns:1fr;gap:6px}
  .bar{height:12px;background:#2a2d33;border-radius:8px;overflow:hidden;box-shadow:inset 0 0 0 1px #0007}
  .fill{height:100%;background:linear-gradient(90deg,#36c,#6cf);width:50%;transition:width .2s}
  .bar.hunger .fill{background:linear-gradient(90deg,#da3a3a,#ff9f43)}
  .bar.thirst .fill{background:linear-gradient(90deg,#2a9dff,#7ad4ff)}
  .bar.energy .fill{background:linear-gradient(90deg,#9b59b6,#c39bd3)}
  .bar.temp .fill{background:linear-gradient(90deg,#3bc26b,#eccc68)}
  .bar.hp .fill{background:linear-gradient(90deg,#27ae60,#2ecc71)}
  .row{display:flex;align-items:center;gap:10px;font-size:12px;opacity:.9}
  .pill{padding:4px 8px;border-radius:999px;background:#22252b;border:1px solid #2e323a}
  .phase{font-weight:600}
  .panel{position:fixed;top:16px;left:16px;padding:12px 14px;border-radius:12px;background:#1b1e24;border:1px solid #2b3038;box-shadow:0 10px 30px #0009}
  .panel h3{margin:0 0 8px 0;font-size:14px;opacity:.9}
  .list{font-size:13px;line-height:1.5}
  .kbd{display:inline-block;padding:2px 6px;border:1px solid #3a3f49;border-bottom-width:2px;border-radius:6px;background:#14161a;font-size:12px}
  .craft{position:fixed;top:16px;right:16px;width:300px;max-width:90vw;padding:12px;border-radius:12px;background:#15171c;border:1px solid #2b3038;box-shadow:0 10px 30px #0009;display:none}
  .craft.open{display:block}
  .craft h3{margin:0 0 8px 0;font-size:14px}
  .craft .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:#1b1e24;margin-bottom:8px;border:1px solid #2b3038}
  .craft .item small{opacity:.8}
  .inv{position:fixed;right:16px;bottom:16px;padding:10px 12px;border-radius:12px;background:#1b1e24;border:1px solid #2b3038}
  .map{position:fixed;left:50%;transform:translateX(-50%);top:16px;padding:8px 10px;border-radius:10px;background:#111318;border:1px solid #2b3038;font-size:12px;display:none}
  .map.open{display:block}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;background:#0f1116;border:1px solid #303646;padding:8px 12px;border-radius:10px;font-size:13px;opacity:.95}
  .dead{position:fixed;inset:0;background:#000b;color:#fff;display:none;place-items:center;text-align:center}
  .dead.open{display:grid}
  a{color:#8ac7ff;text-decoration:none}
</style>
</head>
<body>
<canvas id="game"></canvas>

<div class="panel">
  <h3>Ovládání</h3>
  <div class="list">
    <div><span class="kbd">WASD</span> pohyb &nbsp; <span class="kbd">E</span> interakce &nbsp; <span class="kbd">C</span> crafting &nbsp; <span class="kbd">F</span> postavit &nbsp; <span class="kbd">R</span> spánek &nbsp; <span class="kbd">M</span> mapa</div>
  </div>
</div>

<div class="craft" id="craft">
  <h3>Crafting</h3>
  <div class="item" data-id="fire">
    <div><b>Oheň</b><br><small>Topí, vaří, rychlá energie • 4× dřevo</small></div>
    <button class="kbd craftBuild" data-id="fire">Vybrat</button>
  </div>
  <div class="item" data-id="shelter">
    <div><b>Přístřešek</b><br><small>Bezpečný spánek • 12× dřevo</small></div>
    <button class="kbd craftBuild" data-id="shelter">Vybrat</button>
  </div>
</div>

<div class="map" id="map">Mini-mapa — šedé: les, modré: voda, žluté: louka</div>

<div class="hud">
  <div class="row">
    <span class="pill phase" id="phase">Dítě</span>
    <span class="pill" id="age">Čas: 00:00 / 1:45</span>
    <span class="pill" id="pos">x0,y0</span>
    <span class="pill" id="msg"></span>
  </div>
  <div class="bars">
    <div class="bar hp"><div class="fill" id="hp"></div></div>
    <div class="bar hunger"><div class="fill" id="hunger"></div></div>
    <div class="bar thirst"><div class="fill" id="thirst"></div></div>
    <div class="bar energy"><div class="fill" id="energy"></div></div>
    <div class="bar temp"><div class="fill" id="temp"></div></div>
  </div>
</div>

<div class="inv" id="inv">Dřevo: <b id="wood">0</b> • Bobule: <b id="berries">0</b></div>
<div class="toast" id="toast" style="display:none"></div>

<div class="dead" id="dead">
  <div>
    <h2 id="deadTitle">Zemřel jsi</h2>
    <p id="deadReason">Příčina: hlad</p>
    <p><button class="kbd" onclick="location.reload()">Hrát znovu</button></p>
    <p><small>Tip: u ohně regeneruješ energii a teplotu rychleji.</small></p>
  </div>
</div>

<script>
(function(){
  // --- Config ---
  const LIFE_SECS = 105 * 60; // 1h45m = 6300 s
  const PHASES = [
    {name:"Dítě", start:0, end:45*60, speed:1.2, dmg:0.5, carry:0.6, hungerMul:0.75, thirstMul:0.75},
    {name:"Mladík", start:45*60, end:65*60, speed:1.0, dmg:1.0, carry:1.0, hungerMul:1.0, thirstMul:1.0},
    {name:"Dospělý", start:65*60, end:80*60, speed:0.9, dmg:1.25, carry:1.2, hungerMul:1.0, thirstMul:1.0},
    {name:"Stařec", start:80*60, end:105*60, speed:0.75, dmg:0.8, carry:0.6, hungerMul:1.15, thirstMul:1.15},
  ];
  const TICK = 1/60; // sec per frame approx
  const WORLD = { w: 3000, h: 2000, tile: 50 };
  const H = { hunger:100, thirst:100, energy:100, temp:50, hp:100 };
  const RATES = {
    hunger:-0.008, // per sec base
    thirst:-0.012,
    energyMove:-0.02,
    energyRest:+0.35, // at fire/shelter
    tempAmbient:-0.005, // drift to ambient
    hpStarve:-0.25,
    hpDehyd:-0.35,
    hpColdHot:-0.15
  };
  const AMBIENT = ()=> 45; // simple baseline
  const FIRE_RADIUS = 120;
  const SHELTER_RADIUS = 120;

  // --- State ---
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = window.innerWidth; canvas.height = Math.round(window.innerHeight*0.7); }
  window.addEventListener('resize', resize); resize();

  const keys = new Set();
  window.addEventListener('keydown', e=>{ keys.add(e.key.toLowerCase()); if(['c','m'].includes(e.key.toLowerCase())) e.preventDefault();});
  window.addEventListener('keyup', e=> keys.delete(e.key.toLowerCase()));

  let player = { x: 1500, y: 1200, vx:0, vy:0, speed:140, inv:{wood:0, berries:0}, ageSec:0, alive:true, selectedBuild:null, wisdom:0 };
  let last = performance.now();

  // --- Simple world: water strip + forests + meadows ---
  const waterRects = [{x:200, y:600, w:2600, h:140}];
  const trees = [];
  const bushes = [];
  const structures = []; // {type:'fire'|'shelter',x,y, fuel/time/decay}
  function rnd(a,b){ return a + Math.random()*(b-a); }
  // place trees/bushes
  for(let i=0;i<220;i++){
    const cluster = (i%2===0);
    const x = cluster? rnd(300,2700): rnd(100,2900);
    const y = cluster? rnd(200,900): rnd(1000,1800);
    trees.push({x,y, wood: Math.random()<0.15?0: Math.floor(rnd(2,6)), alive:true});
  }
  for(let i=0;i<90;i++){
    bushes.push({x:rnd(200,2800), y:rnd(200,1700), berries: Math.floor(rnd(1,4)), cooldown:0});
  }

  // --- UI refs ---
  const el = id=>document.getElementById(id);
  const ui = {
    hp: el('hp'), hunger: el('hunger'), thirst: el('thirst'),
    energy: el('energy'), temp: el('temp'),
    phase: el('phase'), age: el('age'), pos: el('pos'),
    wood: el('wood'), berries: el('berries'),
    craft: el('craft'), map: el('map'), toast: el('toast'),
    dead: el('dead'), deadTitle: el('deadTitle'), deadReason: el('deadReason'),
    msg: el('msg')
  };

  // Crafting selections
  document.querySelectorAll('.craftBuild').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      player.selectedBuild = btn.dataset.id;
      showToast("Vybráno: " + (player.selectedBuild==='fire'?'Oheň (F)':'Přístřešek (F)'));
    });
  });

  window.addEventListener('keydown', e=>{
    const k = e.key.toLowerCase();
    if(k==='c'){ ui.craft.classList.toggle('open'); }
    if(k==='m'){ ui.map.classList.toggle('open'); }
    if(k==='f'){ tryBuild(); }
    if(k==='r'){ tryRest(); }
    if(k==='e'){ tryInteract(); }
  });

  function showToast(t,ms=1400){
    ui.toast.textContent=t;
    ui.toast.style.display='block';
    clearTimeout(showToast._t);
    showToast._t=setTimeout(()=> ui.toast.style.display='none', ms);
  }

  function fmtTime(secs){
    const m = Math.floor(secs/60), s = Math.floor(secs%60);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  function getPhase(age){
    return PHASES.find(p=> age>=p.start && age<p.end) || PHASES[PHASES.length-1];
  }

  function near(ax,ay,bx,by,dist){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy <= dist*dist; }

  function tryInteract(){
    // water drink
    for(const r of waterRects){
      if(player.x>r.x-20 && player.x<r.x+r.w+20 && player.y>r.y-10 && player.y<r.y+r.h+10){
        H.thirst = Math.min(100, H.thirst + 18);
        showToast("Piješ vodu (+18 žízeň)");
        return;
      }
    }
    // pick berries
    const bush = bushes.find(b=> b.berries>0 && near(player.x,player.y,b.x,b.y,40));
    if(bush){
      bush.berries--; player.inv.berries++;
      showToast("Sebral jsi bobule (+1)");
      return;
    }
    // eat berries if none nearby and have in inv
    if(player.inv.berries>0){
      player.inv.berries--; H.hunger = Math.min(100, H.hunger+12);
      showToast("Snědl jsi bobule (+12 hlad)");
      return;
    }
    // chop tree (gather wood)
    const tree = trees.find(t=> t.alive && t.wood>0 && near(player.x,player.y,t.x,t.y,48));
    if(tree){
      tree.wood--; if(tree.wood<=0){ tree.alive=false; }
      player.inv.wood++;
      H.energy = Math.max(0, H.energy-2);
      showToast("Získal jsi dřevo (+1)");
      return;
    }
    // rest at fire if near
    const fire = structures.find(s=> s.type==='fire' && near(player.x,player.y,s.x,s.y,40));
    if(fire){
      H.energy = Math.min(100, H.energy+8);
      showToast("Ohříváš se u ohně (+energie)");
      return;
    }
  }

  function tryRest(){
    // only if near fire or shelter
    const s = structures.find(s=> (s.type==='fire' && near(player.x,player.y,s.x,s.y,60)) || (s.type==='shelter' && near(player.x,player.y,s.x,s.y,60)));
    if(!s){ showToast("Potřebuješ oheň nebo přístřešek"); return; }
    // quick nap
    H.energy = Math.min(100, H.energy + 25);
    showToast("Odpočíváš (+25 energie)");
  }

  function tryBuild(){
    if(!player.selectedBuild){ showToast("Otevři crafting (C) a vyber recept"); return; }
    if(player.selectedBuild==='fire'){
      if(player.inv.wood<4){ showToast("Chybí dřevo (4)"); return; }
      player.inv.wood-=4;
      structures.push({type:'fire', x:Math.round(player.x), y:Math.round(player.y), t:120}); // simple lifetime
      showToast("Postavil jsi oheň");
    } else if(player.selectedBuild==='shelter'){
      if(player.inv.wood<12){ showToast("Chybí dřevo (12)"); return; }
      player.inv.wood-=12;
      structures.push({type:'shelter', x:Math.round(player.x), y:Math.round(player.y), decay: 60*60}); // 1h decay
      showToast("Postavil jsi přístřešek");
    }
  }

  function update(dt){
    if(!player.alive) return;
    // movement
    const phase = getPhase(player.ageSec);
    const sp = player.speed * phase.speed * (H.energy<20?0.7:1);
    let dx=0, dy=0;
    if(keys.has('w')) dy-=1;
    if(keys.has('s')) dy+=1;
    if(keys.has('a')) dx-=1;
    if(keys.has('d')) dx+=1;
    if(dx||dy){
      const len = Math.hypot(dx,dy); dx/=len; dy/=len;
      player.x += dx*sp*dt;
      player.y += dy*sp*dt;
      H.energy = Math.max(0, H.energy + RATES.energyMove*dt*60);
    }
    // clamp to world
    player.x = Math.max(40, Math.min(WORLD.w-40, player.x));
    player.y = Math.max(40, Math.min(WORLD.h-40, player.y));

    // world interactions: fire warmth & shelter rest zone
    let nearHeat = false, nearShelter = false;
    for(const s of structures){
      if(s.type==='fire'){
        s.t -= dt;
        if(s.t<=0){ // fire turns to ash
          s.dead = true;
        }
        if(near(player.x,player.y,s.x,s.y,FIRE_RADIUS)) nearHeat = true;
      } else if(s.type==='shelter'){
        s.decay -= dt;
        if(s.decay<=0) s.dead = true;
        if(near(player.x,player.y,s.x,s.y,SHELTER_RADIUS)) nearShelter = true;
      }
    }
    // remove dead structs
    for(let i=structures.length-1;i>=0;i--) if(structures[i].dead) structures.splice(i,1);

    // vitals core
    const hMul = phase.hungerMul, tMul = phase.thirstMul;
    H.hunger = Math.max(0, H.hunger + RATES.hunger*hMul*dt*60);
    H.thirst = Math.max(0, H.thirst + RATES.thirst*tMul*dt*60);

    // energy regen if resting zone (auto small regen)
    if(nearHeat || nearShelter){
      H.energy = Math.min(100, H.energy + RATES.energyRest*dt*60);
    } else {
      // very slow passive loss if idle
      if(!(dx||dy)) H.energy = Math.max(0, H.energy - 0.002*dt*60);
    }

    // temperature drift to ambient (with heat near fire)
    const ambient = AMBIENT();
    const target = nearHeat? Math.min(70, ambient+12) : ambient;
    const diff = target - H.temp;
    H.temp += Math.sign(diff)*Math.min(Math.abs(diff), 0.06*dt*60);
    H.temp = Math.max(0, Math.min(100, H.temp));

    // health damage from zero vitals / temperature extremes
    let dmg = 0;
    if(H.hunger<=0) dmg += -RATES.hpStarve*dt*60;
    if(H.thirst<=0) dmg += -RATES.hpDehyd*dt*60;
    if(H.temp<35 || H.temp>70) dmg += -RATES.hpColdHot*dt*60;
    if(dmg>0){ H.hp = Math.max(0, H.hp - dmg); }

    // age
    player.ageSec += dt;
    if(player.ageSec>=LIFE_SECS){ // died of old age -> wisdom reward
      player.wisdom += Math.floor((player.inv.wood + player.inv.berries)/5) + 25;
      die("Dožil ses stáří. Moudrost +" + player.wisdom);
    }
    if(H.hp<=0){
      die("Zemřel jsi. Příčina: vyčerpání");
    }

    // bushes cooldown
    for(const b of bushes){ if(b.cooldown>0) b.cooldown-=dt; if(b.berries<=0 && b.cooldown<=0){ b.berries=1; b.cooldown = 60+rnd(0,60); } }

    // UI
    ui.phase.textContent = phase.name;
    ui.age.textContent = `Čas: ${fmtTime(player.ageSec)} / 1:45`;
    ui.pos.textContent = `x${Math.round(player.x)}, y${Math.round(player.y)}`;
    ui.hp.style.width = H.hp+"%";
    ui.hunger.style.width = H.hunger+"%";
    ui.thirst.style.width = H.thirst+"%";
    ui.energy.style.width = H.energy+"%";
    ui.temp.style.width = H.temp+"%";
    ui.wood.textContent = player.inv.wood;
    ui.berries.textContent = player.inv.berries;
    // context hint
    ui.msg.textContent = contextHint() || "";
  }

  function die(reason){
    player.alive=false;
    ui.dead.classList.add('open');
    ui.deadReason.textContent = reason;
    // store simple legacy
    try{ localStorage.setItem('legacyWisdom', String((Number(localStorage.getItem('legacyWisdom'))||0) + player.wisdom)); }catch(e){}
  }

  function contextHint(){
    // hint priorities
    const r = waterRects.find(r=> player.x>r.x-20 && player.x<r.x+r.w+20 && player.y>r.y-10 && player.y<r.y+r.h+10);
    if(r) return "E = Pít vodu";
    const bush = bushes.find(b=> b.berries>0 && near(player.x,player.y,b.x,b.y,40));
    if(bush) return "E = Sebrat bobule";
    const tree = trees.find(t=> t.alive && t.wood>0 && near(player.x,player.y,t.x,t.y,48));
    if(tree) return "E = Získat dřevo";
    const fire = structures.find(s=> s.type==='fire' && near(player.x,player.y,s.x,s.y,60));
    if(fire) return "E = Ohřát se • R = Spánek";
    const shel = structures.find(s=> s.type==='shelter' && near(player.x,player.y,s.x,s.y,60));
    if(shel) return "R = Spánek v přístřešku";
    if(player.selectedBuild==='fire') return "F = Postavit oheň (4 dřevo)";
    if(player.selectedBuild==='shelter') return "F = Postavit přístřešek (12 dřevo)";
    return "";
  }

  function draw(){
    // camera
    const cw = canvas.width, ch = canvas.height;
    const cx = Math.max(cw/2, Math.min(WORLD.w - cw/2, player.x));
    const cy = Math.max(ch/2, Math.min(WORLD.h - ch/2, player.y));
    const ox = Math.floor(cx - cw/2);
    const oy = Math.floor(cy - ch/2);

    // bg
    ctx.fillStyle = "#1a1c20"; ctx.fillRect(0,0,cw,ch);

    // ground tiles (simple biomes/visual)
    for(let x=0;x<cw;x+=WORLD.tile){
      for(let y=0;y<ch;y+=WORLD.tile){
        const wx = x+ox, wy=y+oy;
        let c = "#22252b"; // forest
        if(wy>900 && wy<1150) c="#39321f"; // meadow
        ctx.fillStyle=c; ctx.fillRect(x,y,WORLD.tile,WORLD.tile);
      }
    }

    // water
    ctx.fillStyle="#204b73";
    for(const r of waterRects){
      ctx.fillRect(r.x-ox, r.y-oy, r.w, r.h);
    }

    // trees
    for(const t of trees){
      if(!t.alive) continue;
      ctx.fillStyle="#2f6b3b";
      ctx.beginPath(); ctx.arc(t.x-ox,t.y-oy,14,0,Math.PI*2); ctx.fill();
      ctx.fillStyle="#3b2b13"; ctx.fillRect(t.x-ox-2,t.y-oy+12,4,8);
    }

    // bushes
    for(const b of bushes){
      ctx.fillStyle= b.berries>0 ? "#5ea34f" : "#3d5337";
      ctx.beginPath(); ctx.arc(b.x-ox,b.y-oy,10,0,Math.PI*2); ctx.fill();
    }

    // structures
    for(const s of structures){
      if(s.type==='fire'){
        ctx.fillStyle="#8c3f14"; ctx.beginPath(); ctx.arc(s.x-ox,s.y-oy,10,0,Math.PI*2); ctx.fill();
        ctx.fillStyle="#e2a95a"; ctx.beginPath(); ctx.arc(s.x-ox,s.y-oy,6,0,Math.PI*2); ctx.fill();
      } else if(s.type==='shelter'){
        ctx.fillStyle="#6b5a3a"; ctx.fillRect(s.x-ox-14,s.y-oy-10,28,20);
        ctx.fillStyle="#8a6b41"; ctx.fillRect(s.x-ox-16,s.y-oy-16,32,8);
      }
    }

    // player
    ctx.fillStyle="#d7e2ff";
    ctx.beginPath(); ctx.arc(player.x-ox, player.y-oy, 10, 0, Math.PI*2); ctx.fill();
    // direction marker
    ctx.fillStyle="#92b7ff"; ctx.fillRect(player.x-ox-2, player.y-oy-15, 4, 6);

    // highlight interactables
    const hint = contextHint();
    if(hint){
      ctx.fillStyle="#000a"; ctx.fillRect(10,10, cw*0.35, 28);
      ctx.fillStyle="#fff"; ctx.font="14px system-ui"; ctx.fillText(hint, 20, 30);
    }
  }

  function loop(t){
    const dt = Math.min(0.05, (t-last)/1000); last=t;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
