<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>StÅ™edovÄ›kÃ¡ strategie 2.0 â€” city builder + armÃ¡da</title>
<style>
:root{--bg:#0e1015;--panel:#171b22;--mut:#99a6bb;--txt:#e7edf6;--ac:#e2b714;--ok:#33d39a;--bad:#ff6b6b;--line:#242a38}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 800px at 50% -10%,#1d2332 0,#0e1015 60%,#0a0c12 100%);color:var(--txt)}
.wrap{max-width:1200px;margin:auto;padding:14px}
h1{margin:6px 0 10px;font-size:clamp(20px,4.5vw,28px)}h1 span{color:var(--ac)}
.grid{display:grid;gap:12px}
@media(min-width:1080px){.grid{grid-template-columns:1.15fr 1fr}}
.card{background:linear-gradient(180deg,rgba(226,183,20,.06),transparent 35%),var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{background:#212837;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:7px 10px;font-size:14px;display:flex;gap:6px;align-items:center}
.small{font-size:12px;color:var(--mut)}
.sep{height:1px;background:var(--line);margin:8px 0}
.btn{appearance:none;border:none;background:#242c3f;color:#fff;padding:9px 11px;border-radius:10px;border:1px solid rgba(255,255,255,.08);font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.ac{background:linear-gradient(180deg,#6b5b1e,#4f4113);border-color:rgba(226,183,20,.5)}
.btn.good{background:#1d3a2e}
.btn.bad{background:#3a1d1d}
.cols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:860px){.cols{grid-template-columns:1fr}}
/* CITY GRID */
.city{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;user-select:none}
.tile{aspect-ratio:1;background:#0f1420;border:1px solid #20283a;border-radius:8px;display:grid;place-items:center;font-size:13px;color:#cbd6ec}
.tile:hover{outline:2px solid rgba(226,183,20,.4);cursor:pointer}
.tile.water{background:linear-gradient(180deg,#0c2030,#0a1622)}
.tile.forest{background:linear-gradient(180deg,#14241a,#0f1b14)}
.tile.stone{background:linear-gradient(180deg,#202020,#151515)}
.tile.built{background:linear-gradient(180deg,#1b2130,#151b26)}
.tag{padding:3px 8px;border:1px solid rgba(255,255,255,.1);border-radius:999px;background:#1b2130;font-size:11px}
.list{display:grid;gap:8px}
.item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;background:#111722;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
.xs{font-size:12px;color:var(--mut)}
.bar{height:10px;background:#283043;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
.fill{height:100%;background:linear-gradient(90deg,var(--ok),#86f3c6);width:0%}
.fill2{background:linear-gradient(90deg,#f5a742,#e2b714)}
.log{height:180px;overflow:auto;background:#0d1118;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:8px;font-size:14px}
.log p{margin:.35em 0}
.kv{display:grid;grid-template-columns:.9fr 1.1fr;gap:10px}
@media(max-width:860px){.kv{grid-template-columns:1fr}}
.input{width:80px;background:#0f1420;border:1px solid #2a3242;color:#fff;border-radius:8px;padding:6px}
.footer{opacity:.65;text-align:center;font-size:12px;margin-top:10px}
hr{border:none;height:1px;background:var(--line);margin:8px 0}
.right{display:grid;gap:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ° <span>StÅ™edovÄ›kÃ¡ strategie 2.0</span> â€” mÄ›sto, vÃ½zkum, vÃ½cvik, mapy & raidy</h1>

  <!-- TOP BAR -->
  <div class="card">
    <div class="row">
      <div class="pill">ğŸ‘¥ Populace: <b id="pop">0</b>/<b id="cap">0</b></div>
      <div class="pill">ğŸŒ² DÅ™evo: <b id="wood">0</b></div>
      <div class="pill">ğŸª¨ KÃ¡men: <b id="stone">0</b></div>
      <div class="pill">ğŸ– JÃ­dlo: <b id="food">0</b></div>
      <div class="pill">ğŸ’° Mince: <b id="coins">0</b></div>
      <div class="pill">ğŸ“š VÃ½zkum: <b id="science">0</b></div>
    </div>
    <div class="small">Produkce/min: <span id="prod">â€“</span> â€¢ PracovnÃ­ci: <span id="workers">0</span></div>
  </div>

  <div class="grid">
    <!-- LEFT: CITY -->
    <div class="card">
      <div class="row"><h3 style="margin:0">ğŸ— MÄ›sto (10Ã—10)</h3><span class="tag">UmÃ­sti budovy. Stavba trvÃ¡ Äas.</span></div>
      <div class="sep"></div>
      <div class="cols">
        <div>
          <div class="city" id="city"></div>
        </div>
        <div>
          <div class="list" id="buildMenu"></div>
          <div class="sep"></div>
          <div id="buildQueue" class="xs">Å½Ã¡dnÃ¡ stavba neprobÃ­hÃ¡.</div>
          <hr>
          <div class="list" id="workersPanel"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: PANELS -->
    <div class="right">
      <!-- RESEARCH -->
      <div class="card">
        <div class="row"><h3 style="margin:0">ğŸ”¬ VÃ½zkum</h3><span class="tag">Generuje knihovna</span></div>
        <div class="sep"></div>
        <div class="list" id="research"></div>
      </div>

      <!-- ARMY -->
      <div class="card">
        <div class="row"><h3 style="margin:0">âš”ï¸ ArmÃ¡da & vÃ½cvik</h3><span class="tag">bere populaci</span></div>
        <div class="sep"></div>
        <div class="list" id="training"></div>
        <div class="sep"></div>
        <div class="xs">SÃ­la armÃ¡dy: <b id="power">0</b></div>
      </div>

      <!-- WORLD -->
      <div class="card">
        <div class="row"><h3 style="margin:0">ğŸ—ºï¸ SvÄ›tovÃ¡ mapa</h3><span class="tag">Ãºtoky + nÃ¡hodnÃ© raidy</span></div>
        <div class="sep"></div>
        <div id="world" class="list"></div>
        <div class="sep"></div>
        <div class="log" id="log"></div>
        <div class="row" style="justify-content:space-between;margin-top:6px">
          <div class="small">â³ Stamina ÃºtokÅ¯: <b id="stamina">3</b>/3</div>
          <div class="row">
            <button class="btn" id="exportBtn">Export save</button>
            <button class="btn" id="importBtn">Import save</button>
            <input type="file" id="file" style="display:none" accept=".json">
            <button class="btn bad" id="resetBtn">Reset</button>
          </div>
        </div>
        <div class="footer">Auto-save (localStorage). ÄŒasy bÄ›Å¾Ã­ i offline. Raidy mohou ukrÃ¡st suroviny â€” hradby je sniÅ¾ujÃ­.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============ STATE ============ */
const SIZE=10;
const S={
  t:Date.now(),
  res:{wood:150,stone:100,food:100,coins:80,science:0},
  pop:{free:3,used:0,cap:5},
  prod:{wood:0,stone:0,food:0,coins:0,science:0},
  city:[],                              // tiles: {type:'empty|bld', b:'key', busy:{until}}
  buildBusy:null,                       // {x,y,name,until}
  workers:{lumber:0,quarry:0,farm:0,market:0},
  tech:{armory:false,market:false,barracks2:false,catapult:false,walls2:false},
  units:{archer:0,knight:0},
  queues:{archer:null,knight:null},     // {qty,until}
  stamina:{cur:3,max:3,next:0},         // attack energy
  seed:1,
  lastRaid:0
};
/* init grid with some natural tiles */
function initCity(){
  for(let y=0;y<SIZE;y++){const row=[];for(let x=0;x<SIZE;x++){
    let tag="empty";
    // pseudo natural: corners water, band of forest/stone
    if((x<2&&y<2)||(x>7&&y>7)) tag="water";
    else if((x+y)%7===0) tag="forest";
    else if((x*y)%13===0) tag="stone";
    row.push({type:tag,b:null,busy:null});
  } S.city.push(row);}
  // place TownHall center
  const cx=5, cy=5;
  S.city[cy][cx]={type:"bld",b:"townhall",busy:null};
}
if(!localStorage.getItem("ms2_save")) initCity();

/* BUILDINGS DATA */
const B={
  townhall:{name:"Radnice",icon:"ğŸ›ï¸",desc:"ZvyÅ¡uje Äas staveb (vyÅ¡Å¡Ã­ ÃºroveÅˆ = delÅ¡Ã­). OdemykÃ¡ vyÅ¡Å¡Ã­ rozvoj.",cost:{wood:80,stone:80,food:40,coins:40},time:45},
  house:{name:"DÅ¯m",icon:"ğŸ ",desc:"+3 populace.",cost:{wood:40,stone:10,food:10,coins:5},time:20},
  lumber:{name:"Pila",icon:"ğŸŒ²",desc:"PracovnÃ­ci â†’ dÅ™evo.",cost:{wood:30,stone:10},time:20},
  quarry:{name:"Lom",icon:"â›ï¸",desc:"PracovnÃ­ci â†’ kÃ¡men.",cost:{wood:10,stone:30},time:20},
  farm:{name:"Farma",icon:"ğŸŒ¾",desc:"PracovnÃ­ci â†’ jÃ­dlo.",cost:{wood:15,stone:10,food:10},time:20},
  library:{name:"Knihovna",icon:"ğŸ“š",desc:"+vÃ½zkum za minutu.",cost:{wood:40,stone:20,coins:15},time:25},
  market:{name:"TrÅ¾iÅ¡tÄ›",icon:"ğŸª",desc:"+mince (pracovnÃ­ci).",cost:{wood:25,stone:10,coins:20},time:20,requires:"market"},
  barracks:{name:"KasÃ¡rna",icon:"âš”ï¸",desc:"VÃ½cvik jednotek.",cost:{wood:50,stone:25,food:15,coins:20},time:30},
  armory:{name:"Zbrojnice",icon:"ğŸ›¡ï¸",desc:"+ATK/DEF armÃ¡dy.",cost:{wood:35,stone:35,coins:25},time:30,requires:"armory"},
  walls:{name:"Hradby",icon:"ğŸ§±",desc:"SniÅ¾ujÃ­ ztrÃ¡ty pÅ™i raidÅ¯m.",cost:{wood:25,stone:50},time:25},
};
/* UNITS DATA */
const U={
  archer:{name:"LuÄiÅ¡nÃ­k",icon:"ğŸ¹",pop:1,cost:{wood:25,food:15,coins:8},time:25,atk:12,def:4},
  knight:{name:"RytÃ­Å™",icon:"ğŸ—¡ï¸",pop:2,cost:{wood:10,food:25,coins:12},time:35,atk:9,def:12},
};
/* TECH DATA */
const T={
  armory:{name:"ZbrojÃ­Å™stvÃ­",icon:"ğŸ›¡ï¸",desc:"Odemkne Zbrojnici (+ATK/DEF).",cost:60},
  market:{name:"Obchod",icon:"ğŸª™",desc:"Odemkne TrÅ¾iÅ¡tÄ› (+mince z prÃ¡ce).",cost:50},
  barracks2:{name:"VojenskÃ¡ disciplÃ­na",icon:"âš”ï¸",desc:"VÃ½cvik o 25% rychlejÅ¡Ã­.",cost:70},
  walls2:{name:"KamenickÃ© hradby",icon:"ğŸ§±",desc:"Raid ztrÃ¡ty âˆ’30% navÃ­c.",cost:65},
  catapult:{name:"Balista",icon:"ğŸ¯",desc:"+10% sÃ­la armÃ¡dy.",cost:80},
};

/* WORLD NODES */
function rng(a){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}
function makeWorld(seed=1){const R=[];let r=seed;for(let i=0;i<6;i++){r=r+137;const diff=1+Math.floor(rng(r)*8);R.push({
  id:i+1,name:`TÃ¡bor banditÅ¯ ${i+1}`,power:40*diff+Math.floor(rng(r+9)*30),
  loot:{wood:10*diff+~~(rng(r+1)*10),stone:10*diff+~~(rng(r+2)*10),food:10*diff+~~(rng(r+3)*10),coins:6*diff+~~(rng(r+4)*6)}
});}return R}
const WORLD=makeWorld(S.seed);

/* ========= SAVE/LOAD ========= */
function save(){localStorage.setItem("ms2_save",JSON.stringify(S))}
function load(){try{const d=JSON.parse(localStorage.getItem("ms2_save"));if(d){Object.assign(S,d)}}catch(e){}}
load();

/* ========= HELPERS ========= */
const $=s=>document.querySelector(s);
function fmt(n){return Math.floor(n).toLocaleString("cs-CZ")}
function canPay(cost){return Object.keys(cost).every(k=>(S.res[k]||0)>=cost[k])}
function pay(cost){for(const k in cost) S.res[k]-=cost[k]}
function add(cost,sign=+1){for(const k in cost) S.res[k]=(S.res[k]||0)+cost[k]*sign}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function log(msg,cls=""){const p=document.createElement("p");p.innerHTML=msg;if(cls)p.classList.add(cls);LOG.appendChild(p);LOG.scrollTop=LOG.scrollHeight}

/* ========= ECONOMY ========= */
function recalcCap(){ // each house +3, townhall base 5
  let base=5, houses=0;
  for(const row of S.city) for(const t of row) if(t.b==="house") houses++;
  S.pop.cap = base + houses*3;
}
function prodPerMinute(){
  // workers produce; library & market too
  const out={wood:0,stone:0,food:0,coins:0,science:0};
  out.wood   += S.workers.lumber*7;
  out.stone  += S.workers.quarry*6;
  out.food   += S.workers.farm*7;
  out.coins  += S.workers.market*6;
  // libraries flat science
  let libs=0; for(const row of S.city) for(const t of row) if(t.b==="library") libs++;
  out.science += libs*3;
  return out;
}
function tick(dt){ // dt in seconds
  const p=prodPerMinute(); S.prod=p;
  for(const k of ["wood","stone","food","coins"]) S.res[k]+= (p[k]||0)/60*dt;
  S.res.science += (p.science||0)/60*dt;

  // stamina regen (1 per 120s)
  if(!S.stamina.next) S.stamina.next=Date.now()+120000;
  if(Date.now()>=S.stamina.next){S.stamina.cur=clamp(S.stamina.cur+1,0,S.stamina.max);S.stamina.next=Date.now()+120000;}

  // build timers
  if(S.buildBusy && Date.now()>=S.buildBusy.until){
    const {x,y,name}=S.buildBusy;
    S.city[y][x].b=name; S.city[y][x].busy=null; S.city[y][x].type="bld";
    S.buildBusy=null; if(name==="house") recalcCap();
    log(`âœ… DokonÄena stavba: <b>${B[name].name}</b>.`,"good");
  }
  // training
  for(const key of ["archer","knight"]){
    const q=S.queues[key]; if(q && Date.now()>=q.until){
      S.units[key]+=q.qty; S.queues[key]=null; log(`âœ… Dovycvik: <b>${U[key].name} Ã—${q.qty}</b>.`,"good");
    }
  }
  // random raids (every ~90â€“150s check; 30% chance)
  if(!S.lastRaid) S.lastRaid=Date.now();
  if(Date.now()-S.lastRaid> (90000+Math.random()*60000)){
    S.lastRaid=Date.now();
    if(Math.random()<0.3) doRaid();
  }
}
function doRaid(){
  const enemy=60+Math.floor(Math.random()*80);
  const my=armyPower();
  if(my>=enemy){ log(`ğŸ›¡ï¸ Raid odraÅ¾en! (tvÃ¡ sÃ­la ${my} vs ${enemy})`,"good"); return; }
  // loss scaled by walls
  let walls=0; for(const row of S.city) for(const t of row) if(t.b==="walls") walls++;
  let reduce = 0.15*walls; // 15% per walls
  if(S.tech.walls2) reduce += 0.30;
  reduce = Math.min(reduce,0.8);
  const baseLoss={wood:30,stone:30,food:30,coins:20};
  for(const k in baseLoss){const v=Math.round(baseLoss[k]*(1-reduce)); S.res[k]=Math.max(0,S.res[k]-v);}
  log(`ğŸ”¥ NÃ¡jezd banditÅ¯! Prohra (tvÃ¡ ${my} < ${enemy}). ZtrÃ¡ty po hradbÃ¡ch: ğŸŒ²âˆ’${baseLoss.wood*(1-reduce)|0}, ğŸª¨âˆ’${baseLoss.stone*(1-reduce)|0}, ğŸ–âˆ’${baseLoss.food*(1-reduce)|0}, ğŸ’°âˆ’${baseLoss.coins*(1-reduce)|0}.`,"bad");
}

/* ========= CITY UI ========= */
const CITY=$("#city"), LOG=$("#log");
function renderCity(){
  CITY.innerHTML="";
  for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
    const t=S.city[y][x]; const d=document.createElement("div"); d.className="tile";
    if(t.type==="water") d.classList.add("water");
    if(t.type==="forest") d.classList.add("forest");
    if(t.type==="stone") d.classList.add("stone");
    if(t.b) d.classList.add("built");
    d.title = t.b? B[t.b]?.name || "Budova" : "PrÃ¡zdnÃ©";
    d.textContent = t.b ? (B[t.b]?.icon||"ğŸ—") : "";
    d.onclick=()=>placeAt(x,y);
    CITY.appendChild(d);
  }
}
let selectedBuild=null;
function placeAt(x,y){
  const t=S.city[y][x];
  if(t.type==="water") return log("ğŸš« Nelze stavÄ›t na vodÄ›.","bad");
  if(t.b || S.buildBusy) return log("âš ï¸ UÅ¾ stavÃ­Å¡ nebo je dlaÅ¾dice obsazenÃ¡.","bad");
  if(!selectedBuild) return log("â„¹ï¸ Vyber budovu v menu vpravo.","");
  const key=selectedBuild;
  const req=B[key].requires; if(req && !S.tech[req]) return log("ğŸ”’ ChybÃ­ vÃ½zkum k odemÄenÃ­ tÃ©to budovy.","bad");
  if(!canPay(B[key].cost)) return log("âŒ Nedostatek surovin na stavbu.","bad");
  pay(B[key].cost);
  const th = countBuilding("townhall"); // delÅ¡Ã­ Äasy s vÃ­ce TH (postaÄÃ­ 1, ale podporujeme i vÃ­c)
  const tSec = Math.round(B[key].time * (1 + 0.12*(th-1)));
  S.city[y][x].busy={until:Date.now()+tSec*1000,name:key};
  S.buildBusy={x,y,name:key,until:Date.now()+tSec*1000};
  log(`ğŸ—ï¸ Stavba zahÃ¡jena: <b>${B[key].name}</b> (â³ ${tSec}s).`,"good");
}
function countBuilding(key){let c=0;for(const r of S.city)for(const t of r) if(t.b===key) c++;return c;}

function renderBuildMenu(){
  const el=$("#buildMenu"); el.innerHTML="";
  const order=["house","lumber","quarry","farm","library","market","barracks","armory","walls"];
  order.forEach(k=>{
    const b=B[k]; const it=document.createElement("div"); it.className="item";
    const left=document.createElement("div");
    left.innerHTML=`<div class="row"><b>${b.icon} ${b.name}</b> ${b.requires&&!S.tech[b.requires]?'<span class="tag">ğŸ”’ vÃ½zkum</span>':''}</div>
    <div class="xs">${b.desc}</div>
    <div class="xs">Cena: ${priceStr(b.cost)}</div>`;
    const right=document.createElement("div");
    const btn=document.createElement("button"); btn.className="btn ac"; btn.textContent = selectedBuild===k?"VybrÃ¡no":"Postavit";
    btn.disabled=!!(b.requires&&!S.tech[b.requires]);
    btn.onclick=()=>{selectedBuild=k; renderBuildMenu();};
    right.appendChild(btn);
    it.append(left,right); el.appendChild(it);
  });
}
function priceStr(cost){return `ğŸŒ²${cost.wood||0} â€¢ ğŸª¨${cost.stone||0} â€¢ ğŸ–${cost.food||0} â€¢ ğŸ’°${cost.coins||0}`}

function renderBuildQueue(){
  const el=$("#buildQueue");
  if(S.buildBusy){
    const {x,y,name,until}=S.buildBusy;
    const total = B[name].time*1000; // approx for bar (visual)
    const left = Math.max(0,until-Date.now());
    const pct = clamp(100 - left/total*100,0,100);
    el.innerHTML=`ProbÃ­hÃ¡: <b>${B[name].name}</b>
      <div class="bar"><div class="fill fill2" style="width:${pct}%"></div></div>
      <span class="xs">ZbÃ½vÃ¡: ${Math.ceil(left/1000)} s</span>`;
  } else el.textContent="Å½Ã¡dnÃ¡ stavba neprobÃ­hÃ¡.";
}

/* ========= WORKERS ========= */
function maxWorkersFor(type){
  // each building of that type supports up to 3 workers
  let c=0; for(const r of S.city) for(const t of r) if(t.b===type) c++;
  return c*3;
}
function renderWorkers(){
  const el=$("#workersPanel"); el.innerHTML="";
  [["lumber","ğŸŒ² Pila"],["quarry","â›ï¸ Lom"],["farm","ğŸŒ¾ Farma"],["market","ğŸª TrÅ¾iÅ¡tÄ›"]].forEach(([k,label])=>{
    const cap=maxWorkersFor(k);
    const it=document.createElement("div"); it.className="item";
    const left=document.createElement("div");
    left.innerHTML=`<div><b>${label}</b> <span class="tag">prac.: ${S.workers[k]}/${cap}</span></div>
    <div class="xs">+prod. za pracovnÃ­ka â€¢ momentÃ¡lnÄ›: ${prodPerMinute()[k==='lumber'?'wood':k]==null?0:prodPerMinute()[k==='lumber'?'wood':k]} / min</div>`;
    const right=document.createElement("div");
    const minus=document.createElement("button"); minus.className="btn"; minus.textContent="âˆ’";
    const plus=document.createElement("button"); plus.className="btn"; plus.textContent="+";
    minus.onclick=()=>{if(S.workers[k]>0){S.workers[k]--; S.pop.free++; S.pop.used--; renderAll()}};
    plus.onclick =()=>{if(S.workers[k]<cap && S.pop.free>0){S.workers[k]++; S.pop.free--; S.pop.used++; renderAll()}};
    right.append(minus,plus); it.append(left,right); el.appendChild(it);
  });
}

/* ========= RESEARCH ========= */
function renderResearch(){
  const el=$("#research"); el.innerHTML="";
  for(const key of Object.keys(T)){
    const t=T[key]; const owned=S.tech[key];
    const it=document.createElement("div"); it.className="item";
    const left=document.createElement("div");
    left.innerHTML=`<div class="row"><b>${t.icon} ${t.name}</b> ${owned?'<span class="tag">hotovo</span>':''}</div>
    <div class="xs">${t.desc}</div><div class="xs">Cena: ğŸ“š ${t.cost}</div>`;
    const right=document.createElement("div");
    const btn=document.createElement("button"); btn.className="btn ac"; btn.textContent=owned?"Vynalezeno":"Zkoumat";
    btn.disabled=owned || S.res.science < t.cost;
    btn.onclick=()=>{S.res.science-=t.cost; S.tech[key]=true; log(`ğŸ”¬ VÃ½zkum dokonÄen: <b>${t.name}</b>.`,"good"); renderAll();};
    right.appendChild(btn); it.append(left,right); el.appendChild(it);
  }
}

/* ========= ARMY ========= */
function armyPower(){
  let atk=S.units.archer*U.archer.atk + S.units.knight*U.knight.atk;
  let def=S.units.archer*U.archer.def + S.units.knight*U.knight.def;
  // armory bonus
  let arm=0; for(const r of S.city) for(const t of r) if(t.b==="armory") arm++;
  const mult = 1 + arm*0.08 + (S.tech.catapult?0.10:0);
  return Math.round((atk+def)*mult);
}
function renderTraining(){
  const el=$("#training"); el.innerHTML="";
  for(const key of ["archer","knight"]){
    const u=U[key]; const owned=S.units[key]; const q=S.queues[key];
    const it=document.createElement("div"); it.className="item";
    const left=document.createElement("div");
    left.innerHTML=`<div class="row"><b>${u.icon} ${u.name}</b> <span class="tag">jedn.: ${owned}</span></div>
    <div class="xs">Cena/ks: ğŸŒ²${u.cost.wood||0} â€¢ ğŸ–${u.cost.food||0} â€¢ ğŸ’°${u.cost.coins||0} â€¢ Pop: ${u.pop}</div>`;
    const right=document.createElement("div");
    const inp=document.createElement("input"); inp.className="input"; inp.type="number"; inp.min="1"; inp.value="1";
    const btn=document.createElement("button"); btn.className="btn ac"; btn.textContent="CviÄit";
    btn.onclick=()=>{
      const qty=Math.max(1,parseInt(inp.value||"1"));
      const totalCost={wood:(u.cost.wood||0)*qty, stone:0, food:(u.cost.food||0)*qty, coins:(u.cost.coins||0)*qty};
      const popNeed=u.pop*qty;
      if(S.pop.free<popNeed) return log("âŒ Nedostatek volnÃ© populace.","bad");
      if(!canPay(totalCost)) return log("âŒ Nedostatek surovin na vÃ½cvik.","bad");
      if(S.queues[key]) return log("âš ï¸ Tento typ uÅ¾ se cviÄÃ­.","bad");
      pay(totalCost); S.pop.free-=popNeed; S.pop.used+=popNeed;
      let t=u.time*qty; if(S.tech.barracks2) t = Math.round(t*0.75);
      S.queues[key]={qty,until:Date.now()+t*1000};
      log(`ğŸ¹ VÃ½cvik zahÃ¡jen: <b>${u.name} Ã—${qty}</b> (â³ ${t}s).`,"good");
      renderAll();
    };
    right.append(inp,btn);
    // progress
    if(q){
      const total=(U[key].time*(q.qty))*(S.tech.barracks2?0.75:1)*1000;
      const leftMs=Math.max(0,q.until-Date.now());
      const pct=clamp(100-leftMs/total*100,0,100);
      const box=document.createElement("div");
      box.style.width="180px";
      box.innerHTML=`<div class="xs">Ve vÃ½cviku: Ã—${q.qty}</div><div class="bar"><div class="fill" style="width:${pct}%"></div></div><div class="xs">ZbÃ½vÃ¡: ${Math.ceil(leftMs/1000)} s</div>`;
      right.appendChild(box);
    }
    it.append(left,right); el.appendChild(it);
  }
  $("#power").textContent=fmt(armyPower());
}

/* ========= WORLD ========= */
function renderWorld(){
  const el=$("#world"); el.innerHTML="";
  WORLD.forEach(n=>{
    const it=document.createElement("div"); it.className="item";
    const left=document.createElement("div");
    left.innerHTML=`<div class="row"><b>${n.name}</b> <span class="tag">sÃ­la: ${n.power}</span></div>
      <div class="xs">KoÅ™ist: ğŸŒ²${n.loot.wood} â€¢ ğŸª¨${n.loot.stone} â€¢ ğŸ–${n.loot.food} â€¢ ğŸ’°${n.loot.coins}</div>`;
    const right=document.createElement("div");
    const btn=document.createElement("button"); btn.className="btn ac"; btn.textContent="ZaÃºtoÄit";
    btn.onclick=()=>attack(n);
    right.appendChild(btn); it.append(left,right); el.appendChild(it);
  });
}
function attack(node){
  if(S.stamina.cur<=0) return log("ğŸ˜®â€ğŸ’¨ NenÃ­ stamina na Ãºtok. PoÄkej na regeneraci.","bad");
  S.stamina.cur--;
  const my=armyPower(), enemy=node.power + (Math.floor(Math.random()*21)-10);
  if(my>=enemy){
    add(node.loot,+1);
    log(`ğŸ—¡ï¸ VÃ½hra proti <b>${node.name}</b>! Zisk: ğŸŒ²+${node.loot.wood}, ğŸª¨+${node.loot.stone}, ğŸ–+${node.loot.food}, ğŸ’°+${node.loot.coins}.`,"good");
  }else{
    // prohra = ztrÃ¡ty; hradby sniÅ¾ujÃ­
    let walls=0; for(const r of S.city) for(const t of r) if(t.b==="walls") walls++;
    let reduce = 0.12*walls + (S.tech.walls2?0.30:0);
    reduce=Math.min(reduce,0.8);
    const loss={wood:node.loot.wood,stone:node.loot.stone,food:node.loot.food,coins:node.loot.coins};
    for(const k in loss) loss[k]=Math.round(loss[k]*(1-reduce));
    add(loss,-1);
    log(`ğŸ’¥ Prohra proti <b>${node.name}</b> (tvÃ¡ ${my} < ${enemy}). ZtrÃ¡ty: ğŸŒ²âˆ’${loss.wood}, ğŸª¨âˆ’${loss.stone}, ğŸ–âˆ’${loss.food}, ğŸ’°âˆ’${loss.coins}.`,"bad");
  }
  renderAll();
}

/* ========= RENDER ROOT ========= */
function renderTop(){
  $("#wood").textContent=fmt(S.res.wood);
  $("#stone").textContent=fmt(S.res.stone);
  $("#food").textContent=fmt(S.res.food);
  $("#coins").textContent=fmt(S.res.coins);
  $("#science").textContent=fmt(S.res.science);
  $("#pop").textContent=S.pop.free;
  $("#cap").textContent=S.pop.cap;
  // workers sum
  const ws=S.workers.lumber+S.workers.quarry+S.workers.farm+S.workers.market;
  $("#workers").textContent = ws;
  const p=prodPerMinute();
  $("#prod").textContent=`ğŸŒ² ${Math.round(p.wood)}/m â€¢ ğŸª¨ ${Math.round(p.stone)}/m â€¢ ğŸ– ${Math.round(p.food)}/m â€¢ ğŸ’° ${Math.round(p.coins)}/m â€¢ ğŸ“š ${Math.round(p.science)}/m`;
  $("#stamina").textContent = S.stamina.cur;
}
function renderAll(){
  recalcCap();
  renderTop(); renderCity(); renderBuildMenu(); renderBuildQueue(); renderWorkers(); renderResearch(); renderTraining(); renderWorld();
  save();
}

/* ========= LOOP ========= */
let last=Date.now();
function loop(){
  const now=Date.now(); const dt=(now-last)/1000; last=now;
  tick(dt);
  renderTop(); renderBuildQueue(); renderTraining();
  save();
  requestAnimationFrame(loop);
}

/* ========= EXPORT / IMPORT / RESET ========= */
$("#exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify(S,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="save_ms2.json"; a.click();
};
$("#importBtn").onclick=()=>$("#file").click();
$("#file").onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{try{
    const data=JSON.parse(r.result); Object.assign(S,data); log("ğŸ“¥ Save importovÃ¡n.","good"); renderAll();
  }catch(_){ log("âŒ ChybnÃ½ soubor.","bad"); }}; r.readAsText(f);
};
$("#resetBtn").onclick=()=>{ if(!confirm("Resetovat hru?"))return;
  localStorage.removeItem("ms2_save"); location.reload();
};

/* ========= BOOT ========= */
renderAll();
log("ğŸ‘‘ VÃ­tej! StavÄ›j mÄ›sto, zadÃ¡vej pracovnÃ­ky, zkoumej technologie, cviÄ armÃ¡du a dobÃ½vej svÄ›t. Raidy se mohou objevit nÃ¡hodnÄ› â€” hradby pomÃ¡hajÃ­.");
loop();
</script>
</body>
</html>
